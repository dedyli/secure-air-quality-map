<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Air Quality Monitoring Dashboard</title>
    <style>
        :root {
            --dark-bg: #1a1a1a;
            --widget-bg: #2a2a2e;
            --text-primary: #eaeaea;
            --text-secondary: #9ca5b3;
            --border-color: #444;
            --accent-color: #4c8bf5;
        }
        body, html {
            height: 100%;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--dark-bg);
            color: var(--text-primary);
            overflow: hidden;
        }
        .dashboard-container {
            display: flex;
            flex-direction: row-reverse; 
            height: 100vh;
        }
        .sidebar {
            width: 350px;
            background-color: var(--widget-bg);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            border-left: 1px solid var(--border-color); 
            transition: margin-right 0.4s ease;
        }
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative; 
        }
        .widget {
            background-color: var(--dark-bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .widget h3 {
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        .dashboard-header {
            display: flex;
            align-items: center;
            padding: 10px 25px;
            /* --- GRADIENT BACKGROUND UPDATED --- */
            background-image: linear-gradient(to right, #482673, #2a2a2e);
            position: relative;
            border-bottom: 1px solid #444;
            height: 75px; 
            box-sizing: border-box;
        }
        #header-logo {
            height: 50px;
            margin-right: 20px;
            box-sizing: border-box;
        }
        .header-text { flex-grow: 1; }
        .header-text h1 { font-size: 22px; margin: 0 0 4px 0; color: #EAEAEA; }
        .header-text p { font-size: 14px; color: #9ca5b3; margin: 0; }
        .search-container { display: flex; gap: 10px; }
        #address-input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #333;
            color: var(--text-primary);
        }
        #search-button, #sidebar-toggle-btn {
            padding: 8px 12px;
            border: none;
            background-color: var(--accent-color);
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        #sidebar-toggle-btn { background-color: transparent; font-size: 20px; padding: 0 15px;}
        .list-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }
        .list-item:last-child { border-bottom: none; }
        .aqi-value { font-weight: bold; }
        .aqi-good { color: #00e400; }
        .aqi-moderate { color: #ffff00; }
        .aqi-sensitive { color: #ff7e00; }
        .aqi-unhealthy { color: #ff0000; }
        #global-trend-chart { height: 200px; }
        .news-item {
            font-size: 13px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .news-item a { color: var(--accent-color); text-decoration: none; }
        .news-item a:hover { text-decoration: underline; }
        .news-source { display: block; color: var(--text-secondary); font-size: 11px; margin-top: 4px; }
        .info-window-content { color: #111; }
        .loader { text-align: center; padding: 20px; color: var(--text-secondary); }
        .error-message { padding: 20px; text-align: center; background-color: #5d3434; border-radius: 8px; }
        .dashboard-container.sidebar-collapsed .sidebar {
            margin-right: -391px;
        }
        .map-legend, .map-controls {
            background: rgba(42, 42, 46, 0.9);
            padding: 10px 15px;
            margin: 15px !important;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            font-size: 12px;
            color: var(--text-primary);
        }
        .map-legend h4 {
            margin: 0 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .legend-item:last-child {
            margin-bottom: 0;
        }
        .legend-color-box {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .map-controls label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 600;
        }
        .map-controls input {
            margin-right: 8px;
        }
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; top: 0;
            width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.6);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: var(--widget-bg);
            margin: 15% auto;
            padding: 25px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            line-height: 1;
            cursor: pointer;
        }
        .modal-form { display: flex; gap: 10px; margin: 15px 0; }
        #location-input { flex-grow: 1; padding: 10px; border: 1px solid #555; border-radius: 4px; background-color: #333; color: var(--text-primary); }
        #add-location-btn, .save-btn { padding: 10px 15px; border: none; background-color: var(--accent-color); color: white; border-radius: 4px; cursor: pointer; }
        .save-btn { display: block; width: 100%; margin-top: 20px; font-weight: bold; }
        #location-list { list-style: none; padding: 0; max-height: 150px; overflow-y: auto; }
        #location-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--dark-bg);
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 5px;
        }
        .remove-location-btn {
            background: none; border: none; color: #e74c3c; font-size: 20px; line-height: 1; cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <div class="sidebar">
            <div class="widget">
                <h3>Location Search</h3>
                <div class="search-container">
                    <input type="text" id="address-input" placeholder="Enter a city or address">
                    <button id="search-button">Search</button>
                </div>
            </div>

            <div class="widget">
                <h3>Major Cities Air Quality</h3>
                <div id="top-cities-list"></div>
            </div>
            
            <div class="widget">
                <h3>Global AQI Trend (7 Days)</h3>
                <div id="global-trend-chart">
                    <canvas id="aqiTrendChart"></canvas>
                </div>
            </div>

            <div class="widget">
                <h3>Related News</h3>
                <div id="news-list"></div>
            </div>
        </div>
        <main class="main-content">
            <header class="dashboard-header">
                <img src="Tsinghua_University_logo_and_wordmark_in_Chinese_and_English_characters.svg.png" alt="Tsinghua University Logo" id="header-logo">
                <div class="header-text">
                    <h1>Global Air Quality Monitoring Dashboard</h1>
                    <p>Group 62 IEDE Research Topic: <em>AI-Driven Environmental Monitoring for a Green Economy</em></p>
                </div>
                <button id="sidebar-toggle-btn">&#9776;</button>
            </header>
            <div id="map"></div>
        </main>
    </div>
    
    <div id="settings-modal" class="modal">
      <div class="modal-content">
        <span class="close-button">&times;</span>
        <h3>Customize Heatmap Locations</h3>
        <p>Add up to 5 locations. The heatmap will be based on these spots.</p>
        <div class="modal-form">
          <input type="text" id="location-input" placeholder="e.g., Tampines, Singapore">
          <button id="add-location-btn">Add</button>
        </div>
        <ul id="location-list"></ul>
        <button id="save-settings-btn" class="save-btn">Update Heatmap</button>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
    let map, infoWindow, geocoder, heatmap;
    const googleMapsApiKey = "AIzaSyB7tXsMopboB-twZRxqkZOGVZau-sqFjTM";
    const defaultLocations = [
        { name: "Delhi", lat: 28.6139, lng: 77.2090 },
        { name: "Beijing", lat: 39.9042, lng: 116.4074 },
        { name: "Los Angeles", lat: 34.0522, lng: -118.2437 },
        { name: "London", lat: 51.5074, lng: -0.1278 },
        { name: "Mumbai", lat: 19.0760, lng: 72.8777 },
    ];

    function loadGoogleMapsScript() {
        if (!googleMapsApiKey || googleMapsApiKey.includes("YOUR_GOOGLE")) {
            document.getElementById('map').innerHTML = '<div class="error-message">A valid Google Maps API key is required.</div>';
            return; 
        }
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${googleMapsApiKey}&libraries=visualization,places&callback=initMap`;
        script.async = true;
        script.defer = true;
        script.onerror = () => { document.getElementById('map').innerHTML = '<div class="error-message">Error loading Google Maps.</div>'; };
        document.head.appendChild(script);
    }

    window.initMap = function() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 20, lng: 0 },
            zoom: 3,
            mapTypeId: 'roadmap',
            styles: [
                { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
                { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
                { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
                { featureType: "administrative.locality", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
                { featureType: "poi", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
                { featureType: "poi.park", elementType: "geometry", stylers: [{ color: "#263c3f" }] },
                { featureType: "poi.park", elementType: "labels.text.fill", stylers: [{ color: "#6b9a76" }] },
                { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }] },
                { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#212a37" }] },
                { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#9ca5b3" }] },
                { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#746855" }] },
                { featureType: "road.highway", elementType: "geometry.stroke", stylers: [{ color: "#1f2835" }] },
                { featureType: "road.highway", elementType: "labels.text.fill", stylers: [{ color: "#f3d19c" }] },
                { featureType: "transit", elementType: "geometry", stylers: [{ color: "#2f3948" }] },
                { featureType: "transit.station", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
                { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] },
                { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#515c6d" }] },
                { featureType: "water", elementType: "labels.text.stroke", stylers: [{ color: "#17263c" }] },
            ],
        });
        infoWindow = new google.maps.InfoWindow();
        geocoder = new google.maps.Geocoder();

        initDashboard();
        setupEventListeners();
        createMapLegend(); 
        createHeatmapToggle();
        createSettingsControl();
        updateCustomHeatmap();
    };

    function initDashboard() {
        fetchMajorCitiesAirQuality();
        initCharts();
        getNewsData();
    }
    
    function setupEventListeners() {
        map.addListener('click', async (mapsMouseEvent) => {
            const latLng = mapsMouseEvent.latLng;
            infoWindow.setPosition(latLng);
            infoWindow.setContent('<div class="info-window-content">Fetching...</div>');
            infoWindow.open(map);
            try {
                const airQualityData = await getAirQualityDataFromCoords(latLng.lat(), latLng.lng());
                const locationName = await getLocationName(latLng);
                displayAirQualityInfo(airQualityData, locationName, latLng);
            } catch (error) {
                infoWindow.setContent(`<div class="info-window-content"><strong>Error:</strong> ${error.message}</div>`);
            }
        });

        const searchButton = document.getElementById('search-button');
        const addressInput = document.getElementById('address-input');
        searchButton.addEventListener('click', () => geocodeAddress(addressInput.value));
        addressInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') geocodeAddress(addressInput.value); });
        
        const toggleButton = document.getElementById('sidebar-toggle-btn');
        const dashboardContainer = document.querySelector('.dashboard-container');
        toggleButton.addEventListener('click', () => {
            dashboardContainer.classList.toggle('sidebar-collapsed');
            setTimeout(() => { if (map) { google.maps.event.trigger(map, 'resize'); } }, 400);
        });

        setupModalEventListeners();
    }

    async function getAirQualityDataFromCoords(lat, lng) {
        try {
            const response = await fetch(`https://airquality.googleapis.com/v1/currentConditions:lookup?key=${googleMapsApiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ location: { latitude: lat, longitude: lng } })
            });
            if (response.ok) {
                const data = await response.json();
                if (data.indexes && data.indexes.length > 0) {
                    const universalAQI = data.indexes.find(index => index.code === 'uaqi') || data.indexes[0];
                    return { aqi: universalAQI.aqi, category: universalAQI.category, dominantPollutant: universalAQI.dominantPollutant, pm25Value: data.pollutants?.find(p => p.code === 'pm25')?.concentration?.value || null };
                }
            }
            throw new Error('Google API returned no data');
        } catch (error) {
            throw new Error('Unable to fetch air quality data');
        }
    }
    
    async function fetchMajorCitiesAirQuality() {
        const container = document.getElementById('top-cities-list');
        container.innerHTML = '<div class="loader">Loading...</div>';
        try {
            const cityPromises = defaultLocations.map(async city => {
                try {
                    const data = await getAirQualityDataFromCoords(city.lat, city.lng);
                    return { name: city.name, aqi: data.aqi };
                } catch (error) { return null; }
            });
            const results = (await Promise.all(cityPromises)).filter(r => r !== null);
            if (results.length === 0) throw new Error('No city data');
            results.sort((a, b) => b.aqi - a.aqi);
            container.innerHTML = '';
            results.forEach((city, index) => {
                const listItem = document.createElement('div');
                listItem.className = 'list-item';
                listItem.innerHTML = `<span class="city-name">${index + 1}. ${city.name}</span><span class="aqi-value ${getAqiColorClass(city.aqi)}">AQI ${city.aqi}</span>`;
                container.appendChild(listItem);
            });
        } catch (error) {
            container.innerHTML = `<div class="error-message">Could not load city data.</div>`;
        }
    }

    async function fetchTrendData() {
        try {
            const delhiCoords = { lat: 28.6139, lng: 77.2090 };
            const response = await fetch(`https://airquality.googleapis.com/v1/history:lookup?key=${googleMapsApiKey}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ location: { latitude: delhiCoords.lat, longitude: delhiCoords.lng }, pageSize: 7, period: "P7D" })
            });
            if (response.ok) {
                const data = await response.json();
                if (data.hoursInfo && data.hoursInfo.length > 0) {
                    const dailyData = {};
                    data.hoursInfo.forEach(hour => {
                        const date = new Date(hour.dateTime).toDateString();
                        const universalAQI = hour.indexes?.find(index => index.code === 'uaqi');
                        if (universalAQI) {
                            if (!dailyData[date]) { dailyData[date] = { total: 0, count: 0 }; }
                            dailyData[date].total += universalAQI.aqi;
                            dailyData[date].count++;
                        }
                    });
                    const sortedDays = Object.keys(dailyData).sort((a, b) => new Date(a) - new Date(b));
                    const labels = sortedDays.map(day => new Date(day).toLocaleDateString('en-US', { weekday: 'short' }));
                    const values = sortedDays.map(day => Math.round(dailyData[day].total / dailyData[day].count));
                    if (values.length >= 3) return { labels, data: values, city: 'Delhi (Google API)' };
                }
            }
        } catch (error) { console.log('Could not fetch historical data:', error); }
        return { labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'], data: [85, 92, 78, 105, 118, 95, 82], city: 'Sample Data' };
    }
    
    function getNewsData() {
        const newsListContainer = document.getElementById('news-list');
        newsListContainer.innerHTML = `
            <div class="news-item"><a href="https://www.who.int/news-room/fact-sheets/detail/ambient-(outdoor)-air-quality-and-health" target="_blank" rel="noopener noreferrer">WHO: Ambient (outdoor) air quality and health</a><span class="news-source">World Health Organization</span></div>
            <div class="news-item"><a href="https://www.epa.gov/pm-pollution" target="_blank" rel="noopener noreferrer">Particulate Matter (PM) Pollution</a><span class="news-source">US EPA</span></div>
            <div class="news-item"><a href="https://openaq.org/" target="_blank" rel="noopener noreferrer">OpenAQ - Open Air Quality Data Platform</a><span class="news-source">OpenAQ Platform</span></div>
        `;
    }

    async function initCharts() {
        const chartContainer = document.getElementById('global-trend-chart');
        try {
            const { labels, data, city } = await fetchTrendData();
            const ctx = document.getElementById('aqiTrendChart').getContext('2d'); 
            new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: `Air Quality Index (${city})`, data: data, borderColor: '#4C8BF5', backgroundColor: 'rgba(76, 139, 245, 0.2)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 200, ticks: { color: '#EAEAEA' }, grid: { color: 'rgba(234, 234, 234, 0.1)' } }, x: { ticks: { color: '#EAEAEA' }, grid: { color: 'rgba(234, 234, 234, 0.1)' } } }, plugins: { legend: { display: true, position: 'top', labels: { color: '#EAEAEA' } } } } }); 
        } catch (error) {
            chartContainer.innerHTML = `<div class="error-message">Could not load trend data.</div>`;
        }
    }

    function displayAirQualityInfo(data, locationName, position) { 
        if (!data || !data.aqi) { 
            infoWindow.setContent(`<div class="info-window-content"><strong>${locationName}</strong><br>No data available.</div>`); 
            return; 
        } 
        const { aqi, category, pm25Value, dominantPollutant } = data;
        const colorClass = getAqiColorClass(aqi);
        let contentHtml = `<div class="info-window-content"><h3>${locationName}</h3><p><strong>AQI:</strong> <span style="color: ${getColorFromClass(colorClass)}">${aqi}</span></p><p><strong>Category:</strong> ${category}</p>`;
        if (pm25Value) contentHtml += `<p><strong>PM2.5:</strong> ${pm25Value.toFixed(1)} µg/m³</p>`;
        if (dominantPollutant) contentHtml += `<p><strong>Main Pollutant:</strong> ${dominantPollutant.toUpperCase()}</p>`;
        contentHtml += `</div>`;
        infoWindow.setContent(contentHtml); 
    }
    
    function getColorFromClass(colorClass) {
        switch(colorClass) {
            case 'aqi-good': return '#00E400'; case 'aqi-moderate': return '#FFFF00';
            case 'aqi-sensitive': return '#FF7E00'; case 'aqi-unhealthy': return '#FF0000';
            default: return '#FF0000';
        }
    }

    function getLocationName(latLng) {
        return new Promise((resolve) => {
            geocoder.geocode({ 'location': latLng }, (results, status) => {
                if (status === 'OK' && results[0]) { resolve(results[0].formatted_address); } 
                else { resolve("Location name not found"); }
            });
        });
    }

    async function geocodeAddress(address) {
        if (!address) { return; }
        geocoder.geocode({ 'address': address }, async (results, status) => {
            if (status === 'OK') {
                const location = results[0].geometry.location;
                map.setCenter(location);
                map.setZoom(11);
                infoWindow.setPosition(location);
                infoWindow.setContent('<div class="info-window-content">Fetching...</div>');
                infoWindow.open(map);
                try {
                    const airQualityData = await getAirQualityDataFromCoords(location.lat(), location.lng());
                    displayAirQualityInfo(airQualityData, results[0].formatted_address, location);
                } catch (error) {
                    infoWindow.setContent(`<div class="info-window-content"><strong>Error:</strong> ${error.message}</div>`);
                }
            } else {
                alert('Geocode was not successful: ' + status);
            }
        });
    }
    
    function getAqiColorClass(aqi) {
        if (aqi <= 50) return 'aqi-good'; if (aqi <= 100) return 'aqi-moderate';
        if (aqi <= 150) return 'aqi-sensitive'; return 'aqi-unhealthy';
    }

    async function updateCustomHeatmap() {
        let customLocations = JSON.parse(localStorage.getItem('heatmapLocations'));
        let locationsToProcess;

        if (customLocations && customLocations.length > 0) {
            const geocodedPromises = customLocations.map(name => new Promise(resolve => {
                geocoder.geocode({ 'address': name }, (results, status) => {
                    if (status === 'OK') {
                        resolve({ name: name, lat: results[0].geometry.location.lat(), lng: results[0].geometry.location.lng() });
                    } else {
                        console.warn(`Could not geocode ${name}`);
                        resolve(null);
                    }
                });
            }));
            locationsToProcess = (await Promise.all(geocodedPromises)).filter(loc => loc !== null);
        } else {
            locationsToProcess = defaultLocations;
        }

        generateHeatmap(locationsToProcess);
    }
    
    async function generateHeatmap(locations) {
        const heatmapData = [];
        const cityPromises = locations.map(async city => {
            try {
                const data = await getAirQualityDataFromCoords(city.lat, city.lng);
                if (data && data.aqi) {
                    return { location: new google.maps.LatLng(city.lat, city.lng), weight: data.aqi };
                }
            } catch (error) { /* Silently fail for individual points */ }
            return null;
        });

        const validPoints = (await Promise.all(cityPromises)).filter(p => p !== null);
        
        if (!heatmap) {
            heatmap = new google.maps.visualization.HeatmapLayer({ data: validPoints, map: map });
            heatmap.set('radius', 50);
            heatmap.set('opacity', 0.7);
            heatmap.set('maxIntensity', 200);
            const gradient = ['rgba(0, 255, 255, 0)','rgba(0, 255, 255, 1)','rgba(0, 255, 0, 1)','rgba(255, 255, 0, 1)','rgba(255, 0, 0, 1)'];
            heatmap.set('gradient', gradient);
        } else {
            heatmap.setData(validPoints);
        }
        document.getElementById('toggle-heatmap-checkbox').checked = true;
        heatmap.setMap(map);
    }

    function createMapLegend() {
        const legend = document.createElement('div');
        legend.className = 'map-legend';
        const legendItems = [{ color: '#00E400', label: 'Good (0-50)' },{ color: '#FFFF00', label: 'Moderate (51-100)' },{ color: '#FF7E00', label: 'Sensitive (101-150)' },{ color: '#FF0000', label: 'Unhealthy (151+)' }];
        let content = '<h4>AQI Legend</h4>';
        legendItems.forEach(item => { content += `<div class="legend-item"><span class="legend-color-box" style="background-color:${item.color};"></span>${item.label}</div>`; });
        legend.innerHTML = content;
        map.controls[google.maps.ControlPosition.LEFT_BOTTOM].push(legend);
    }
    
    function createHeatmapToggle() {
        const controlDiv = document.createElement('div');
        controlDiv.className = 'map-controls';
        controlDiv.innerHTML = `<label><input type="checkbox" id="toggle-heatmap-checkbox" checked>Show Heatmap</label>`;
        map.controls[google.maps.ControlPosition.LEFT_BOTTOM].push(controlDiv);
        controlDiv.querySelector('#toggle-heatmap-checkbox').addEventListener('change', (e) => {
            heatmap.setMap(e.target.checked ? map : null);
        });
    }

    function createSettingsControl() {
        const controlDiv = document.createElement('div');
        controlDiv.style.margin = '15px';
        controlDiv.innerHTML = `<button title="Customize Heatmap Locations" style="background-color: #2a2a2e; border: 1px solid #444; border-radius: 4px; padding: 8px; cursor: pointer;"><span style="font-size: 20px;">⚙️</span></button>`;
        map.controls[google.maps.ControlPosition.TOP_RIGHT].push(controlDiv);
        controlDiv.querySelector('button').addEventListener('click', () => {
            document.getElementById('settings-modal').style.display = 'block';
            renderLocationList();
        });
    }
    
    function setupModalEventListeners() {
        const modal = document.getElementById('settings-modal');
        const closeBtn = document.querySelector('.close-button');
        const addBtn = document.getElementById('add-location-btn');
        const saveBtn = document.getElementById('save-settings-btn');
        const locationInput = document.getElementById('location-input');

        closeBtn.onclick = () => { modal.style.display = 'none'; };
        window.onclick = (event) => { if (event.target == modal) modal.style.display = 'none'; };
        
        addBtn.onclick = () => {
            let locations = JSON.parse(localStorage.getItem('heatmapLocations')) || [];
            if (locations.length >= 5) {
                alert('You can add a maximum of 5 locations.');
                return;
            }
            const newLocation = locationInput.value.trim();
            if (newLocation && !locations.includes(newLocation)) {
                locations.push(newLocation);
                localStorage.setItem('heatmapLocations', JSON.stringify(locations));
                renderLocationList();
                locationInput.value = '';
            }
        };

        saveBtn.onclick = () => {
            modal.style.display = 'none';
            updateCustomHeatmap();
        };
    }

    function renderLocationList() {
        const list = document.getElementById('location-list');
        let locations = JSON.parse(localStorage.getItem('heatmapLocations')) || [];
        list.innerHTML = '';
        locations.forEach((location, index) => {
            const li = document.createElement('li');
            li.textContent = location;
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-location-btn';
            removeBtn.innerHTML = '&times;';
            removeBtn.onclick = () => {
                locations.splice(index, 1);
                localStorage.setItem('heatmapLocations', JSON.stringify(locations));
                renderLocationList();
            };
            li.appendChild(removeBtn);
            list.appendChild(li);
        });
    }
    
    document.addEventListener('DOMContentLoaded', loadGoogleMapsScript);
    </script>
</body>
</html>