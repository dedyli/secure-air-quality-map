<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Air Quality Monitoring Dashboard</title>
    <link rel="stylesheet" href="dashboard-style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #1A1A1A;
            color: #EAEAEA;
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow: hidden;
        }
        
        .dashboard-header {
            display: flex;
            align-items: center;
            padding: 10px 25px;
            background-color: #F8F9FA;
            position: relative;
            border-bottom: 1px solid #DEE2E6;
            height: 75px; 
            box-sizing: border-box;
        }
        #header-logo {
            height: 50px;
            margin-right: 20px;
        }
        .header-text {
            flex-grow: 1;
        }
        .header-text h1 {
            font-size: 22px;
            margin-bottom: 4px;
            color: #212529;
        }
        .header-text p {
            font-size: 14px;
            color: #495057;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: 1fr 380px;
            height: calc(100vh - 75px);
            padding: 15px;
            gap: 15px;
            transition: grid-template-columns 0.4s ease-in-out;
        }

        .map-panel, .sidebar {
            height: 100%;
            position: relative;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow: hidden;
        }
        
        .widget {
            background-color: #2a2a2e;
            border-radius: 8px;
            padding: 15px 20px;
            display: flex;
            flex-direction: column;
        }
        
        .widget-content.scrollable {
             overflow-y: auto;
        }
        #news-list.widget-content {
            flex-grow: 1;
        }

        .widget-title { margin: 0 0 15px 0; font-weight: 500; border-bottom: 1px solid #444; padding-bottom: 10px; }
        
        .list-item {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            margin: 0 -12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .list-item:hover { background-color: #3a414a; }
        .list-item .city-name {
            flex-grow: 1;
        }
        .list-item .aqi-value {
            margin-left: 15px;
        }
        
        .aqi-value { font-weight: 700; }
        .aqi-value.aqi-good { color: #00E400; }
        .aqi-value.aqi-moderate { color: #FFFF00; }
        .aqi-value.aqi-sensitive { color: #FF7E00; }
        .aqi-value.aqi-unhealthy { color: #FF0000; }
        
        #sidebar-toggle-btn {
            background-color: rgba(76, 139, 245, 0.8);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            font-size: 20px;
            line-height: 1;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-left: 20px;
        }
        #sidebar-toggle-btn:hover { background-color: rgba(76, 139, 245, 1); }

        .dashboard-container.sidebar-collapsed { grid-template-columns: 1fr 0; gap: 0; }

        #legend-map {
            position: absolute; bottom: 30px; right: 10px; background-color: rgba(30, 30, 30, 0.85);
            backdrop-filter: blur(5px); color: #fff; padding: 10px 15px; border-radius: 8px; z-index: 5;
            font-size: 14px; line-height: 1.5; border: 1px solid rgba(255, 255, 255, 0.1);
        }
        #legend-map h4 { margin: 0 0 8px 0; text-align: center; font-weight: 500; border-bottom: 1px solid #444; padding-bottom: 5px; }
        #legend-map div { display: flex; align-items: center; margin-bottom: 4px; }
        #legend-map div:last-child { margin-bottom: 0; }
        #legend-map span { width: 14px; height: 14px; border-radius: 50%; margin-right: 10px; display: inline-block; border: 1px solid #555; }

        .error-message {
            color: #FF7E00;
        }
    </style>
</head>
<body>
    <header class="dashboard-header">
        <img src="Tsinghua_University_logo_and_wordmark_in_Chinese_and_English_characters.svg.png" alt="Tsinghua University Logo" id="header-logo">
        <div class="header-text">
            <h1>Global Air Quality Monitoring Dashboard</h1>
            <p>Group 62 IEDE Research Topic: AI-Driven Environmental Monitoring for a Green Economy</p>
        </div>
        <button id="sidebar-toggle-btn" title="Toggle Sidebar">☰</button>
    </header>

    <div class="dashboard-container">
        <main class="map-panel">
            <div id="search-container">
                <input id="address-input" type="text" placeholder="Enter a location to search">
                <button id="search-button">Search</button>
            </div>
            <div id="map"></div>
            <div id="legend-map">
                <h4>AQI Legend (PM2.5 µg/m³)</h4>
                <div><span style="background-color: #00E400;"></span> 0-12: Good</div>
                <div><span style="background-color: #FFFF00;"></span> 13-35: Moderate</div>
                <div><span style="background-color: #FF7E00;"></span> 36-55: Unhealthy for Sensitive</div>
                <div><span style="background-color: #FF0000;"></span> 56+: Unhealthy</div>
            </div>
        </main>

        <aside class="sidebar">
            <div class="widget">
                <h3 class="widget-title">Top 5 Most Polluted Cities</h3>
                <div id="top-cities-list" class="widget-content">
                    <div class="loader">Loading live city data...</div>
                </div>
            </div>

            <div class="widget">
                <h3 class="widget-title">Global PM2.5 Trend (Last 7 Days)</h3>
                <div id="global-trend-chart" class="widget-content">
                    <canvas id="aqiTrendChart"></canvas>
                </div>
            </div>

            <div class="widget">
                <h3 class="widget-title">Air Pollution News & Research</h3>
                <div id="news-list" class="widget-content scrollable">
                    <div class="loader">Loading news feed...</div>
                </div>
            </div>
        </aside>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_Maps_API_KEY&libraries=visualization,places&callback=initMap" async defer></script>

    <script>
    let map, infoWindow, geocoder;
    const openAqApiKey = "9f408ed0e450f2c243ab27af6c475b1b8a4f0b6d776a82b55781cb0ab5190a89";
    const openAqApiUrl = "https://api.openaq.org/v2/";

    async function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 20, lng: 0 }, zoom: 3, mapTypeId: 'satellite',
            styles: [
                { elementType: 'geometry', stylers: [{ color: '#242f3e' }] }, { elementType: 'labels.text.stroke', stylers: [{ color: '#242f3e' }] }, { elementType: 'labels.text.fill', stylers: [{ color: '#746855' }] },
                { featureType: 'administrative.locality', elementType: 'labels.text.fill', stylers: [{ color: '#d59563' }] }, { featureType: 'poi', elementType: 'labels.text.fill', stylers: [{ color: '#d59563' }] },
                { featureType: 'poi.park', elementType: 'geometry', stylers: [{ color: '#263c3f' }] }, { featureType: 'poi.park', elementType: 'labels.text.fill', stylers: [{ color: '#6b9a76' }] },
                { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#38414e' }] }, { featureType: 'road', elementType: 'geometry.stroke', stylers: [{ color: '#212a37' }] },
                { featureType: 'road', elementType: 'labels.text.fill', stylers: [{ color: '#9ca5b3' }] }, { featureType: 'road.highway', elementType: 'geometry', stylers: [{ color: '#746855' }] },
                { featureType: 'road.highway', elementType: 'geometry.stroke', stylers: [{ color: '#1f2835' }] }, { featureType: 'road.highway', elementType: 'labels.text.fill', stylers: [{ color: '#f3d19c' }] },
                { featureType: 'transit', elementType: 'geometry', stylers: [{ color: '#2f3948' }] }, { featureType: 'transit.station', elementType: 'labels.text.fill', stylers: [{ color: '#d59563' }] },
                { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#17263c' }] }, { featureType: 'water', elementType: 'labels.text.fill', stylers: [{ color: '#515c6d' }] },
                { featureType: 'water', elementType: 'labels.text.stroke', stylers: [{ color: '#17263c' }] }
            ]
        });
        infoWindow = new google.maps.InfoWindow();
        geocoder = new google.maps.Geocoder();

        map.addListener('click', async (mapsMouseEvent) => {
            const latLng = mapsMouseEvent.latLng;
            infoWindow.setPosition(latLng); infoWindow.setContent('Fetching location data...'); infoWindow.open(map);
            try {
                const airQualityData = await getAirQualityData(latLng.lat(), latLng.lng());
                const locationName = await getLocationName(latLng);
                displayAirQualityInfo(airQualityData, locationName, latLng);
            } catch (error) {
                console.error('Detailed Error:', error); infoWindow.setContent(`<div class="info-window-content"><strong>Error:</strong> ${error.message}</div>`);
            }
        });
        const searchButton = document.getElementById('search-button');
        const addressInput = document.getElementById('address-input');
        searchButton.addEventListener('click', () => geocodeAddress(addressInput.value));
        addressInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') geocodeAddress(addressInput.value); });
        
        initDashboard();
    }
    
    async function initDashboard() {
        initCharts();
        getNewsData();
        fetchTopPollutedCities();
        document.getElementById('top-cities-list').addEventListener('click', handleCityClick);
    }
    
    // --- NEW: Function to get top polluted cities from OpenAQ ---
    async function fetchTopPollutedCities() {
        const topCitiesListContainer = document.getElementById('top-cities-list');
        topCitiesListContainer.innerHTML = '<div class="loader">Loading live city data...</div>';
        
        const url = `${openAqApiUrl}latest?limit=100&page=1&offset=0&sort=desc&parameter=pm25&order_by=value`;

        try {
            const response = await fetch(url, { headers: { 'X-API-Key': openAqApiKey } });
            if (!response.ok) throw new Error(`OpenAQ API Error: ${response.statusText}`);
            const data = await response.json();

            if (data.results && data.results.length > 0) {
                populateTopCitiesList(data.results.slice(0, 5));
            } else {
                topCitiesListContainer.innerHTML = '<div class="error-message">No live city data available from OpenAQ.</div>';
            }
        } catch (error) {
            console.error("Error fetching top polluted cities:", error);
            topCitiesListContainer.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
        }
    }
    
    function populateTopCitiesList(cities) {
        const listContainer = document.getElementById('top-cities-list');
        listContainer.innerHTML = ''; 

        cities.forEach((city, index) => {
            const listItem = document.createElement('div');
            listItem.className = 'list-item';
            listItem.setAttribute('data-lat', city.coordinates.latitude);
            listItem.setAttribute('data-lng', city.coordinates.longitude);
            listItem.setAttribute('data-name', city.location);
            listItem.setAttribute('data-aqi', city.value);

            const colorClass = getAqiColorClass(city.value);
            const cityName = city.city ? `${city.location}, ${city.city}` : city.location;

            listItem.innerHTML = `
                <span class="city-name">${index + 1}. ${cityName}</span>
                <span class="aqi-value ${colorClass}">${city.value.toFixed(2)}</span>
            `;
            listContainer.appendChild(listItem);
        });
    }
    
    // --- MODIFIED: Use OpenAQ API for clicks as well ---
    async function getAirQualityData(lat, lng) {
        const url = `${openAqApiUrl}latest?coordinates=${lat},${lng}&radius=10000&parameter=pm25`;
        const response = await fetch(url, { headers: { 'X-API-Key': openAqApiKey } });

        if (!response.ok) {
            throw new Error('Failed to fetch Air Quality data from OpenAQ.');
        }
        const data = await response.json();
        if (data.results && data.results.length > 0) {
            return data.results[0];
        } else {
            throw new Error('No air quality stations found near this location.');
        }
    }

    async function geocodeAddress(address) { if (!address) { alert('Please enter a location to search.'); return; } geocoder.geocode({ 'address': address }, async (results, status) => { if (status === 'OK') { const location = results[0].geometry.location; map.setCenter(location); map.setZoom(11); try { const airQualityData = await getAirQualityData(location.lat(), location.lng()); displayAirQualityInfo(airQualityData, results[0].formatted_address, location); } catch (error) { console.error('Geocode Error:', error); infoWindow.setContent(`<div class="info-window-content"><strong>Error:</strong> ${error.message}</div>`); infoWindow.open(map); } } else { alert('Geocode was not successful for the following reason: ' + status); } }); }
    async function getLocationName(latLng) { return new Promise((resolve, reject) => { geocoder.geocode({ 'location': latLng }, (results, status) => { if (status === 'OK') { if (results[0]) { resolve(results[0].formatted_address); } else { resolve("Location name not found"); } } else { console.error("Geocoder failed due to: " + status); resolve("Location name not found"); } }); }); }
    
    // Note: This color coding is based on the US EPA AQI standard for PM2.5 (µg/m³).
    function getAqiColorClass(value) {
        if (value <= 12) return 'aqi-good';
        if (value <= 35.4) return 'aqi-moderate';
        if (value <= 55.4) return 'aqi-sensitive';
        return 'aqi-unhealthy';
    }

    function getStandardCategoryFromAqi(value) {
        if (value <= 12) return 'Good';
        if (value <= 35.4) return 'Moderate';
        if (value <= 55.4) return 'Unhealthy for Sensitive Groups';
        if (value <= 150.4) return 'Unhealthy';
        if (value <= 250.4) return 'Very Unhealthy';
        return 'Hazardous';
    }

    function displayAirQualityInfo(data, locationName, position) { 
        infoWindow.setPosition(position); 
        if (!data || !data.value) { 
            infoWindow.setContent(`<div class="info-window-content"><strong>${locationName}</strong><br>No air quality data available.</div>`); 
            infoWindow.open(map); return; 
        } 
        const { value, parameter } = data; 
        const standardCategory = getStandardCategoryFromAqi(value); 
        infoWindow.setContent(`<div class="info-window-content"><h3>${locationName}</h3><p><strong>PM2.5:</strong> ${value.toFixed(2)} µg/m³</p><p><strong>Category:</strong> ${standardCategory}</p><p><strong>Source:</strong> ${data.location}</p></div>`); 
        infoWindow.open(map); 
    }

    // --- NEW: Fetch 7-day trend from OpenAQ ---
    async function fetchWeeklyTrendData() {
        const dateTo = new Date();
        const dateFrom = new Date();
        dateFrom.setDate(dateFrom.getDate() - 7);

        const formatDate = (date) => date.toISOString().split('T')[0];
        
        const url = `${openAqApiUrl}averages?spatial=country&country=US&parameter=pm25&date_from=${formatDate(dateFrom)}&date_to=${formatDate(dateTo)}&limit=100`;

        try {
            const response = await fetch(url, { headers: { 'X-API-Key': openAqApiKey } });
            if (!response.ok) throw new Error(`OpenAQ API Error: ${response.statusText}`);
            const data = await response.json();
            
            if(data.results && data.results.length > 0) {
                // Assuming the API returns daily averages for the date range
                const dailyAverages = data.results.reduce((acc, curr) => {
                    const day = curr.day;
                    if (!acc[day]) {
                        acc[day] = { sum: 0, count: 0 };
                    }
                    acc[day].sum += curr.average;
                    acc[day].count++;
                    return acc;
                }, {});

                const labels = Object.keys(dailyAverages).sort();
                const chartData = labels.map(day => dailyAverages[day].sum / dailyAverages[day].count);

                return { labels, data: chartData };
            }
            return { labels: [], data: [] };
        } catch (error) {
            console.error("Error fetching weekly trend data:", error);
            return { labels: [], data: [] };
        }
    }

    async function initCharts() {
        const { labels, data } = await fetchWeeklyTrendData();
        const ctx = document.getElementById('aqiTrendChart').getContext('2d'); 
        
        new Chart(ctx, { 
            type: 'line', 
            data: { 
                labels: labels.length > 0 ? labels : ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'], 
                datasets: [{ 
                    label: 'Global Average PM2.5', 
                    data: data.length > 0 ? data : [], 
                    borderColor: '#4C8BF5', 
                    backgroundColor: 'rgba(76, 139, 245, 0.2)', 
                    fill: true, 
                    tension: 0.4 
                }] 
            }, 
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                scales: { y: { beginAtZero: false, ticks: { color: '#EAEAEA' } }, x: { ticks: { color: '#EAEAEA' } } }, 
                plugins: { legend: { display: false } } 
            } 
        }); 
    }

    function handleCityClick(event) {
        const cityItem = event.target.closest('.list-item');
        if (!cityItem) return;
        const lat = parseFloat(cityItem.dataset.lat);
        const lng = parseFloat(cityItem.dataset.lng);
        const name = cityItem.dataset.name;
        const aqi = parseFloat(cityItem.dataset.aqi);
        const location = new google.maps.LatLng(lat, lng);
        map.setCenter(location);
        map.setZoom(11);
        const airQualityData = {
            value: aqi,
            parameter: 'pm25',
            location: name
        };
        displayAirQualityInfo(airQualityData, name, location);
    }

    async function getNewsData() {
        const newsApiKey = "eb6e1360b30c6a7f876690a5ef785d0f"; // Replace with your GNews API key if needed
        const query = encodeURIComponent('"air pollution" OR "air quality"');
        const newsUrl = `https://gnews.io/api/v4/search?q=${query}&lang=en&max=10&apikey=${newsApiKey}`;
        const newsListContainer = document.getElementById('news-list');
        try {
            const response = await fetch(newsUrl);
            if (!response.ok) {
                const err = new Error(`HTTP error! Status: ${response.status}`);
                err.status = response.status;
                throw err;
            }
            const data = await response.json();
            populateNewsList(data.articles);
        } catch (error) {
            console.error("Could not fetch news:", error);
            if (error.status === 401) { newsListContainer.innerHTML = `<div class="error-message">News feed error: Invalid API Key.</div>`; } else if (error.status === 403) { newsListContainer.innerHTML = `<div class="error-message">News feed error: Access denied.</div>`; } else { newsListContainer.innerHTML = `<div class="error-message">Could not load news feed.</div>`; }
        }
    }

    function populateNewsList(articles) {
        const newsListContainer = document.getElementById('news-list');
        newsListContainer.innerHTML = '';
        if (!articles || articles.length === 0) {
            newsListContainer.innerHTML = 'No recent news articles found.';
            return;
        }
        articles.forEach(article => {
            const newsItem = document.createElement('div');
            newsItem.className = 'news-item';
            const publishedDate = new Date(article.publishedAt);
            const timeAgo = getTimeAgo(publishedDate);
            newsItem.innerHTML = `<a href="${article.url}" target="_blank" rel="noopener noreferrer">${article.title}</a><span class="news-source">${article.source.name} &middot; ${timeAgo}</span>`;
            newsListContainer.appendChild(newsItem);
        });
    }

    function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + " years ago";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + " months ago";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + " days ago";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + " hours ago";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + " minutes ago";
        return Math.floor(seconds) + " seconds ago";
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        const toggleButton = document.getElementById('sidebar-toggle-btn');
        const dashboardContainer = document.querySelector('.dashboard-container');
        if (toggleButton && dashboardContainer) {
            toggleButton.addEventListener('click', () => {
                dashboardContainer.classList.toggle('sidebar-collapsed');
                setTimeout(() => { if (map) { google.maps.event.trigger(map, 'resize'); } }, 400);
            });
        }
    });
    </script>
</body>
</html>
