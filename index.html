<!DOCTYPE html>
<html>
<head>
    <title>Global Air Quality Visualization</title>
    <style>
        /* Basic styling for the map and controls */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: sans-serif;
            background-color: #1a1a1a;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        /* Style for the title panel */
        #title-panel {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 800px;
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 5;
            font-size: 18px;
            text-align: center;
            box-sizing: border-box;
            line-height: 1.4;
        }

        /* CSS FOR SEARCH BAR */
        #search-container {
            position: absolute;
            top: 85px; /* Positioned below the title */
            left: 50%;
            transform: translateX(-50%);
            z-index: 5;
            display: flex;
            background-color: rgba(0, 0, 0, 0.75);
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        #address-input {
            width: 320px;
            padding: 8px 12px;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #333;
            color: #fff;
            font-size: 16px;
        }
        #search-button {
            padding: 8px 16px;
            margin-left: 8px;
            border: none;
            border-radius: 4px;
            background-color: #4C8BF5; /* Google blue color */
            color: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        #search-button:hover {
            background-color: #437ae2;
        }

        .info-window-content { color: #333; }
        .info-window-content h3 { margin: 0; color: #111; }
        .info-window-content p { margin: 5px 0 0; }
        .info-window-content i { color: #666; font-size: 0.9em; }

        /* CSS FOR AQI LEGEND */
        #legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.75);
            color: #fff;
            padding: 10px 15px;
            border-radius: 8px;
            z-index: 5;
            font-size: 14px;
            line-height: 1.5;
        }
        #legend h4 {
            margin: 0 0 5px 0;
            text-align: center;
        }
        #legend div {
            display: flex;
            align-items: center;
        }
        #legend span {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 8px;
            display: inline-block;
            border: 1px solid #555;
        }

    </style>
</head>
<body>
    <div id="title-panel">
        Group 62 Project : AI Driven Environmental Monitoring for Green Economy<br>IEDE program Tsinghua University
    </div>

    <div id="search-container">
        <input id="address-input" type="text" placeholder="Enter a location to search">
        <button id="search-button">Search</button>
    </div>
    <div id="map"></div>

    <div id="legend">
        <h4>AQI Legend (0-100)</h4>
        <div><span style="background-color: #FF0000;"></span> 0-25: Unhealthy</div>
        <div><span style="background-color: #FF7E00;"></span> 26-50: Moderate</div>
        <div><span style="background-color: #FFFF00;"></span> 51-75: Good</div>
        <div><span style="background-color: #00E400;"></span> 76-100: Excellent</div>
    </div>

    <script>
    let map;
    let infoWindow;
    let geocoder;

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 20, lng: 0 },
            zoom: 3,
            mapTypeId: 'satellite',
            styles: [
                { elementType: 'geometry', stylers: [{ color: '#242f3e' }] }, { elementType: 'labels.text.stroke', stylers: [{ color: '#242f3e' }] },
                { elementType: 'labels.text.fill', stylers: [{ color: '#746855' }] }, { featureType: 'administrative.locality', elementType: 'labels.text.fill', stylers: [{ color: '#d59563' }] },
                { featureType: 'poi', elementType: 'labels.text.fill', stylers: [{ color: '#d59563' }] }, { featureType: 'poi.park', elementType: 'geometry', stylers: [{ color: '#263c3f' }] },
                { featureType: 'poi.park', elementType: 'labels.text.fill', stylers: [{ color: '#6b9a76' }] }, { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#38414e' }] },
                { featureType: 'road', elementType: 'geometry.stroke', stylers: [{ color: '#212a37' }] }, { featureType: 'road', elementType: 'labels.text.fill', stylers: [{ color: '#9ca5b3' }] },
                { featureType: 'road.highway', elementType: 'geometry', stylers: [{ color: '#746855' }] }, { featureType: 'road.highway', elementType: 'geometry.stroke', stylers: [{ color: '#1f2835' }] },
                { featureType: 'road.highway', elementType: 'labels.text.fill', stylers: [{ color: '#f3d19c' }] }, { featureType: 'transit', elementType: 'geometry', stylers: [{ color: '#2f3948' }] },
                { featureType: 'transit.station', elementType: 'labels.text.fill', stylers: [{ color: '#d59563' }] }, { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#17263c' }] },
                { featureType: 'water', elementType: 'labels.text.fill', stylers: [{ color: '#515c6d' }] }, { featureType: 'water', elementType: 'labels.text.stroke', stylers: [{ color: '#17263c' }] }
            ]
        });

        infoWindow = new google.maps.InfoWindow();
        geocoder = new google.maps.Geocoder();

        const airQualityHeatmap = new google.maps.visualization.HeatmapLayer({
            data: getSimulatedHeatmapData(),
            map: map,
            radius: 35,
            opacity: 0.7,
            // INVERTED GRADIENT: Red (Bad) for low values, Green (Good) for high values.
            gradient: [
                'rgba(255, 0, 0, 0)',      // Transparent Red
                'rgba(255, 0, 0, 1)',      // Red
                'rgba(255, 126, 0, 1)',    // Orange
                'rgba(255, 255, 0, 1)',    // Yellow
                'rgba(0, 228, 0, 1)'       // Green
            ]
        });

        map.addListener('click', async (mapsMouseEvent) => {
            const latLng = mapsMouseEvent.latLng;

            infoWindow.setPosition(latLng);
            infoWindow.setContent('Fetching location and air quality data...');
            infoWindow.open(map);

            try {
                const [locationName, airQualityData] = await Promise.all([
                    getLocationName(latLng),
                    getAirQualityData(latLng.toJSON())
                ]);

                displayAirQualityInfo(airQualityData, locationName, latLng);

            } catch (error) {
                console.error('Detailed Error:', error);
                infoWindow.setContent(
                    `<div class="info-window-content">
                        <strong>Error: Could not retrieve data.</strong><br>
                        <p><strong>Reason:</strong> ${error.message}</p><br>
                        <i>There might be an issue with the backend function.</i>
                    </div>`
                );
            }
        });

        const searchButton = document.getElementById('search-button');
        const addressInput = document.getElementById('address-input');

        searchButton.addEventListener('click', () => {
            geocodeAddress(addressInput.value);
        });

        addressInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                geocodeAddress(addressInput.value);
            }
        });
    }

    async function geocodeAddress(address) {
        if (!address) {
            alert('Please enter a location to search.');
            return;
        }

        geocoder.geocode({ 'address': address }, async (results, status) => {
            if (status === 'OK') {
                const location = results[0].geometry.location;
                map.setCenter(location);
                map.setZoom(11);

                infoWindow.setPosition(location);
                infoWindow.setContent(`Fetching air quality for ${results[0].formatted_address}...`);
                infoWindow.open(map);

                try {
                    const locationName = results[0].formatted_address;
                    const airQualityData = await getAirQualityData(location.toJSON());
                    displayAirQualityInfo(airQualityData, locationName, location);
                } catch (error) {
                    console.error('Detailed Error:', error);
                    infoWindow.setContent(
                        `<div class="info-window-content">
                            <strong>${results[0].formatted_address}</strong><br>
                            <strong>Error:</strong> Could not retrieve air quality data.<br>
                            <p><i>${error.message}</i></p>
                        </div>`
                    );
                }
            } else {
                alert('Geocode was not successful for the following reason: ' + status);
            }
        });
    }

    async function getLocationName(latLng) {
        const response = await fetch(`/.netlify/functions/getGeocode?lat=${latLng.lat()}&lng=${latLng.lng()}`);
        const data = await response.json();
        return data.results?.[0]?.formatted_address || "Location name not found";
    }

    async function getAirQualityData(latLngJson) {
        const response = await fetch('/.netlify/functions/getAirQuality', {
            method: 'POST',
            body: JSON.stringify({
                latitude: latLngJson.lat,
                longitude: latLngJson.lng,
            }),
        });
        if (!response.ok) {
            const errorDetails = await response.json().catch(() => ({ error: { message: 'Could not parse error response.' } }));
            const errorMessage = errorDetails.error?.message || `Request failed with status ${response.status}`;
            throw new Error(errorMessage);
        }
        return response.json();
    }
    
    // Logic for the new 0-100 inverted scale
    function getCategoryForNewScale(aqi) {
        if (aqi <= 25) return 'Unhealthy';
        if (aqi <= 50) return 'Moderate';
        if (aqi <= 75) return 'Good';
        if (aqi <= 100) return 'Excellent';
        return 'N/A'; // For values outside the new range
    }

    function getSimulatedHeatmapData() {
        const locations = [
            { lat: 34.0522, lng: -118.2437 }, { lat: 19.4326, lng: -99.1332 },
            { lat: 40.7128, lng: -74.0060 }, { lat: -23.5505, lng: -46.6333 },
            { lat: -34.6037, lng: -58.3816 }, { lat: 51.5074, lng: -0.1278 },
            { lat: 48.8566, lng: 2.3522 }, { lat: 55.7558, lng: 37.6173 },
            { lat: 6.5244, lng: 3.3792 }, { lat: 30.0444, lng: 31.2357 },
            { lat: 39.9042, lng: 116.4074 }, { lat: 35.6895, lng: 139.6917 },
            { lat: 19.0760, lng: 72.8777 }, { lat: -6.2088, lng: 106.8456 },
            { lat: -33.8688, lng: 151.2093 },
        ];
        const heatmapData = [];
        locations.forEach(location => {
            // Generate data within the new 0-100 scale for the simulation
            const simulatedAqi = Math.random() * 100; 
            heatmapData.push({
                location: new google.maps.LatLng(location.lat, location.lng),
                weight: simulatedAqi
            });
        });
        return heatmapData;
    }

    function displayAirQualityInfo(data, locationName, position) {
        if (data.error || !data.indexes || data.indexes.length === 0) {
            infoWindow.setContent(`<strong>${locationName}</strong><br>No air quality data available.`);
            return;
        }

        const { aqi, dominantPollutant, color } = data.indexes[0];
        
        // Use the new 0-100 scale logic for the category text
        const newCategory = getCategoryForNewScale(aqi);

        const contentString = `
            <div class="info-window-content">
                <h3>${locationName}</h3>
                <p><strong>AQI:</strong> ${aqi}</p>
                <p><strong>Category:</strong> <span style="color: ${color ? `rgb(${Math.round(color.red*255)}, ${Math.round(color.green*255)}, ${Math.round(color.blue*255)})` : '#000'}">${newCategory}</span></p>
                <p><strong>Dominant Pollutant:</strong> ${dominantPollutant}</p>
            </div>`;

        infoWindow.setPosition(position);
        infoWindow.setContent(contentString);
    }

    function loadMapScript() {
        const script = document.createElement('script');
        const CLIENT_SIDE_API_KEY = "AIzaSyB7tXsMopboB-twZRxqkZOGVZau-sqFjTM"; // <-- PASTE YOUR KEY HERE
        script.src = `https://maps.googleapis.com/maps/api/js?key=${CLIENT_SIDE_API_KEY}&libraries=visualization,places&callback=initMap`;
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
    }

    loadMapScript();

    </script>
</body>
</html>