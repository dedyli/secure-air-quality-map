<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Air Quality Monitoring Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body{background-color:#1A1A1A;color:#EAEAEA;font-family:'Inter',sans-serif;margin:0;overflow:hidden}
        .dashboard-header{display:flex;align-items:center;padding:10px 25px;background-color:#F8F9FA;position:relative;border-bottom:1px solid #DEE2E6;height:75px;box-sizing:border-box}
        #header-logo{height:50px;margin-right:20px}
        .header-text{flex-grow:1}
        .header-text h1{font-size:22px;margin-bottom:4px;color:#212529}
        .header-text p{font-size:14px;color:#495057}
        .dashboard-container{display:grid;grid-template-columns:1fr 380px;height:calc(100vh - 75px);padding:15px;gap:15px;transition:grid-template-columns .4s ease-in-out}
        .map-panel,.sidebar{height:100%;position:relative}
        .sidebar{display:flex;flex-direction:column;gap:15px;overflow:hidden}
        .widget{background-color:#2a2a2e;border-radius:8px;padding:15px 20px;display:flex;flex-direction:column}
        .widget-content.scrollable{overflow-y:auto}
        #news-list.widget-content{flex-grow:1}
        .widget-title{margin:0 0 15px;font-weight:500;border-bottom:1px solid #444;padding-bottom:10px}
        .list-item{display:flex;align-items:center;padding:6px 12px;margin:0 -12px;border-radius:4px;cursor:pointer;transition:background-color .2s ease-in-out}
        .list-item:hover{background-color:#3a414a}
        .list-item .city-name{flex-grow:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .list-item .aqi-value{margin-left:15px;flex-shrink:0}
        .aqi-value{font-weight:700}
        .aqi-value.aqi-good{color:#00E400}
        .aqi-value.aqi-moderate{color:#FFFF00}
        .aqi-value.aqi-sensitive{color:#FF7E00}
        .aqi-value.aqi-unhealthy{color:#FF0000}
        #sidebar-toggle-btn{background-color:rgba(76,139,245,.8);color:#fff;border:none;border-radius:5px;padding:8px 12px;font-size:20px;line-height:1;cursor:pointer;transition:background-color .3s;margin-left:20px}
        #sidebar-toggle-btn:hover{background-color:rgba(76,139,245,1)}
        .dashboard-container.sidebar-collapsed{grid-template-columns:1fr 0;gap:0}
        #legend-map{position:absolute;bottom:30px;right:10px;background-color:rgba(30,30,30,.85);backdrop-filter:blur(5px);color:#fff;padding:10px 15px;border-radius:8px;z-index:5;font-size:14px;line-height:1.5;border:1px solid rgba(255,255,255,.1)}
        #legend-map h4{margin:0 0 8px;text-align:center;font-weight:500;border-bottom:1px solid #444;padding-bottom:5px}
        #legend-map div{display:flex;align-items:center;margin-bottom:4px}
        #legend-map div:last-child{margin-bottom:0}
        #legend-map span{width:14px;height:14px;border-radius:50%;margin-right:10px;display:inline-block;border:1px solid #555}
        .error-message{color:#FF7E00}
    </style>
</head>
<body>
    <header class="dashboard-header">
        <img src="Tsinghua_University_logo_and_wordmark_in_Chinese_and_English_characters.svg.png" alt="Tsinghua University Logo" id="header-logo">
        <div class="header-text">
            <h1>Global Air Quality Monitoring Dashboard</h1>
            <p>Group 62 IEDE Research Topic: AI-Driven Environmental Monitoring for a Green Economy</p>
        </div>
        <button id="sidebar-toggle-btn" title="Toggle Sidebar">â˜°</button>
    </header>
    <div class="dashboard-container">
        <main class="map-panel">
            <div id="search-container">
                <input id="address-input" type="text" placeholder="Enter a location to search">
                <button id="search-button">Search</button>
            </div>
            <div id="map"></div>
            <div id="legend-map">
                <h4>AQI Legend</h4>
                <div><span style="background-color: #00E400;"></span> 0-50: Good</div>
                <div><span style="background-color: #FFFF00;"></span> 51-100: Moderate</div>
                <div><span style="background-color: #FF7E00;"></span> 101-150: Unhealthy for Sensitive</div>
                <div><span style="background-color: #FF0000;"></span> 151+: Unhealthy</div>
            </div>
        </main>
        <aside class="sidebar">
            <div class="widget">
                <h3 class="widget-title">Top 5 Most Polluted Cities</h3>
                <div id="top-cities-list" class="widget-content">
                    <div class="loader">Loading live city data...</div>
                </div>
            </div>
            <div class="widget">
                <h3 class="widget-title">Global AQI Trend (Last 7 Days)</h3>
                <div id="global-trend-chart" class="widget-content">
                    <canvas id="aqiTrendChart"></canvas>
                </div>
            </div>
            <div class="widget">
                <h3 class="widget-title">Air Pollution News & Research</h3>
                <div id="news-list" class="widget-content scrollable">
                    <div class="loader">Loading news feed...</div>
                </div>
            </div>
        </aside>
    </div>

    <script>
    let map, infoWindow, geocoder, trendChart;
    let googleApiKey; // Store the key for reuse

    // Predefined list of major world cities for ranking
    const majorCities = [
        { name: "Delhi, India", lat: 28.7041, lng: 77.1025 }, { name: "Dhaka, Bangladesh", lat: 23.8103, lng: 90.4125 },
        { name: "Beijing, China", lat: 39.9042, lng: 116.4074 }, { name: "Karachi, Pakistan", lat: 24.8607, lng: 67.0011 },
        { name: "Jakarta, Indonesia", lat: -6.2088, lng: 106.8456 }, { name: "Lagos, Nigeria", lat: 6.5244, lng: 3.3792 },
        { name: "Cairo, Egypt", lat: 30.0444, lng: 31.2357 }, { name: "Mexico City, Mexico", lat: 19.4326, lng: -99.1332 },
        { name: "Sao Paulo, Brazil", lat: -23.5505, lng: -46.6333 }, { name: "Mumbai, India", lat: 19.0760, lng: 72.8777 },
        { name: "Shanghai, China", lat: 31.2304, lng: 121.4737 }, { name: "Kolkata, India", lat: 22.5726, lng: 88.3639 },
        { name: "Manila, Philippines", lat: 14.5995, lng: 120.9842 }, { name: "Moscow, Russia", lat: 55.7558, lng: 37.6173 },
        { name: "Bangkok, Thailand", lat: 13.7563, lng: 100.5018 }, { name: "Tehran, Iran", lat: 35.6892, lng: 51.3890 },
        { name: "Los Angeles, USA", lat: 34.0522, lng: -118.2437 }, { name: "London, UK", lat: 51.5074, lng: -0.1278 },
        { name: "Johannesburg, South Africa", lat: -26.2041, lng: 28.0473 }, { name: "Santiago, Chile", lat: -33.4489, lng: -70.6693 }
    ];

    async function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 20, lng: 0 }, zoom: 3, mapTypeId: 'satellite',
            styles: [
                { elementType: 'geometry', stylers: [{ color: '#242f3e' }] }, { elementType: 'labels.text.stroke', stylers: [{ color: '#242f3e' }] }, { elementType: 'labels.text.fill', stylers: [{ color: '#746855' }] }, { featureType: 'administrative.locality', elementType: 'labels.text.fill', stylers: [{ color: '#d59563' }] }, { featureType: 'poi', elementType: 'labels.text.fill', stylers: [{ color: '#d59563' }] }, { featureType: 'poi.park', elementType: 'geometry', stylers: [{ color: '#263c3f' }] }, { featureType: 'poi.park', elementType: 'labels.text.fill', stylers: [{ color: '#6b9a76' }] }, { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#38414e' }] }, { featureType: 'road', elementType: 'geometry.stroke', stylers: [{ color: '#212a37' }] }, { featureType: 'road', elementType: 'labels.text.fill', stylers: [{ color: '#9ca5b3' }] }, { featureType: 'road.highway', elementType: 'geometry', stylers: [{ color: '#746855' }] }, { featureType: 'road.highway', elementType: 'geometry.stroke', stylers: [{ color: '#1f2835' }] }, { featureType: 'road.highway', elementType: 'labels.text.fill', stylers: [{ color: '#f3d19c' }] }, { featureType: 'transit', elementType: 'geometry', stylers: [{ color: '#2f3948' }] }, { featureType: 'transit.station', elementType: 'labels.text.fill', stylers: [{ color: '#d59563' }] }, { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#17263c' }] }, { featureType: 'water', elementType: 'labels.text.fill', stylers: [{ color: '#515c6d' }] }, { featureType: 'water', elementType: 'labels.text.stroke', stylers: [{ color: '#17263c' }] }
            ]
        });
        infoWindow = new google.maps.InfoWindow();
        geocoder = new google.maps.Geocoder();
        
        map.addListener('click', async (mapsMouseEvent) => {
            const latLng = mapsMouseEvent.latLng;
            infoWindow.setPosition(latLng); infoWindow.setContent('Fetching location data...'); infoWindow.open(map);
            try {
                const [locationName, airQualityData] = await Promise.all([getLocationName(latLng), getAirQualityData(latLng)]);
                displayAirQualityInfo(airQualityData, locationName, latLng);
            } catch (error) {
                console.error('Detailed Error:', error); infoWindow.setContent(`<div class="info-window-content"><strong>Error:</strong> ${error.message}</div>`);
            }
        });
        const searchButton = document.getElementById('search-button');
        const addressInput = document.getElementById('address-input');
        searchButton.addEventListener('click', () => geocodeAddress(addressInput.value));
        addressInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') geocodeAddress(addressInput.value); });

        initCharts();
        getNewsData();

        const topCitiesListContainer = document.getElementById('top-cities-list');
        try {
            const liveTopCities = await fetchGoogleTopCitiesData();
            if (liveTopCities && liveTopCities.length > 0) {
                populateTopCitiesList(liveTopCities);
            } else {
                topCitiesListContainer.innerHTML = '<div class="error-message">Could not load live city data from Google.</div>';
            }
        } catch (error) {
            topCitiesListContainer.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
        }
        document.getElementById('top-cities-list').addEventListener('click', handleCityClick);
    }
    
    async function fetchGoogleTopCitiesData() {
        if (!googleApiKey) {
            console.error("Google API Key not available for Air Quality requests.");
            return [];
        }
        const promises = majorCities.map(city => {
            return fetch(`https://airquality.googleapis.com/v1/currentConditions:lookup?key=${googleApiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ location: { latitude: city.lat, longitude: city.lng } })
            }).then(response => response.json())
              .then(data => ({ ...city, aqi: data.indexes && data.indexes[0] ? data.indexes[0].aqi : 0 }))
              .catch(error => { console.error(`Error fetching AQI for ${city.name}:`, error); return { ...city, aqi: 0 }; });
        });
        try {
            const citiesWithAqi = await Promise.all(promises);
            citiesWithAqi.sort((a, b) => b.aqi - a.aqi);
            return citiesWithAqi.slice(0, 5);
        } catch (error) {
            console.error("Failed to fetch or process city AQI data:", error);
            return [];
        }
    }

    function populateTopCitiesList(cities) {
        const listContainer = document.getElementById('top-cities-list');
        listContainer.innerHTML = ''; 
        cities.forEach((city, index) => {
            const listItem = document.createElement('div');
            listItem.className = 'list-item';
            listItem.setAttribute('data-lat', city.lat); listItem.setAttribute('data-lng', city.lng);
            listItem.setAttribute('data-name', city.name); listItem.setAttribute('data-aqi', city.aqi);
            const colorClass = getAqiColorClass(city.aqi);
            listItem.innerHTML = `<span class="city-name">${index + 1}. ${city.name}</span><span class="aqi-value ${colorClass}">${city.aqi}</span>`;
            listContainer.appendChild(listItem);
        });
    }

    async function getAirQualityData(latLng) {
        const response = await fetch(`https://airquality.googleapis.com/v1/currentConditions:lookup?key=${googleApiKey}`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ location: { latitude: latLng.lat(), longitude: latLng.lng() } })
        });
        if (!response.ok) throw new Error('Failed to fetch Air Quality data from Google.');
        return await response.json();
    }
    
    function loadMapScript() {
        const script = document.createElement('script');
        // --- PASTE YOUR GOOGLE MAPS API KEY HERE ---
        googleApiKey = "YOUR_Maps_API_KEY"; 
        script.src = `https://maps.googleapis.com/maps/api/js?key=${googleApiKey}&libraries=places&callback=initMap`;
        script.async = true; script.defer = true;
        script.onerror = () => { document.getElementById('map').innerText = 'Error: Could not load Google Maps...'; };
        document.head.appendChild(script);
    }
    
    function initCharts() {
        const ctx = document.getElementById('aqiTrendChart').getContext('2d');
        trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Global Average AQI', data: [55, 60, 58, 62, 70, 75, 72],
                    borderColor: '#4C8BF5', backgroundColor: 'rgba(76, 139, 245, 0.2)',
                    fill: true, tension: 0.4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false } }, plugins: { legend: { display: false } } }
        });
    }

    function handleCityClick(event) {
        const cityItem = event.target.closest('.list-item');
        if (!cityItem) return;
        const lat = parseFloat(cityItem.dataset.lat); const lng = parseFloat(cityItem.dataset.lng);
        const name = cityItem.dataset.name; const aqi = parseInt(cityItem.dataset.aqi);
        const location = new google.maps.LatLng(lat, lng);
        map.setCenter(location); map.setZoom(11);
        displayAirQualityInfo({ indexes: [{ aqi, dominantPollutant: 'PM2.5' }] }, name, location);
    }
    
    async function getNewsData() {
        const newsApiKey = "eb6e1360b30c6a7f876690a5ef785d0f"; // Note: This is a demo key and may expire.
        const query = encodeURIComponent('"air pollution" OR "air quality"');
        const newsUrl = `https://gnews.io/api/v4/search?q=${query}&lang=en&max=10&apikey=${newsApiKey}`;
        const newsListContainer = document.getElementById('news-list');
        try {
            const response = await fetch(newsUrl);
            if (!response.ok) { const err = new Error(`HTTP error! Status: ${response.status}`); err.status = response.status; throw err; }
            const data = await response.json();
            populateNewsList(data.articles);
        } catch (error) {
            console.error("Could not fetch news:", error);
            if (error.status === 401) { newsListContainer.innerHTML = `<div class="error-message">News feed error: Invalid API Key.</div>`; } 
            else if (error.status === 403) { newsListContainer.innerHTML = `<div class="error-message">News feed error: Access denied.</div>`; }
            else { newsListContainer.innerHTML = `<div class="error-message">Could not load news feed.</div>`; }
        }
    }

    function populateNewsList(articles) {
        const newsListContainer = document.getElementById('news-list');
        newsListContainer.innerHTML = '';
        if (!articles || articles.length === 0) { newsListContainer.innerHTML = 'No recent news articles found.'; return; }
        articles.forEach(article => {
            const newsItem = document.createElement('div');
            newsItem.className = 'news-item';
            const publishedDate = new Date(article.publishedAt);
            const timeAgo = getTimeAgo(publishedDate);
            newsItem.innerHTML = `<a href="${article.url}" target="_blank" rel="noopener noreferrer">${article.title}</a><span class="news-source">${article.source.name} &middot; ${timeAgo}</span>`;
            newsListContainer.appendChild(newsItem);
        });
    }

    async function geocodeAddress(address) { if (!address) { alert('Please enter a location to search.'); return; } geocoder.geocode({ 'address': address }, async (results, status) => { if (status === 'OK') { const location = results[0].geometry.location; map.setCenter(location); map.setZoom(11); try { const airQualityData = await getAirQualityData(location); displayAirQualityInfo(airQualityData, results[0].formatted_address, location); } catch (error) { console.error('Geocode Error:', error); infoWindow.setContent(`<div class="info-window-content"><strong>Error:</strong> Could not retrieve data for this location.</div>`); } } else { alert('Geocode was not successful for the following reason: ' + status); } }); }
    async function getLocationName(latLng) { return new Promise((resolve) => { geocoder.geocode({ 'location': latLng }, (results, status) => { if (status === 'OK' && results[0]) { resolve(results[0].formatted_address); } else { resolve("Location name not found"); } }); }); }
    function getStandardCategoryFromAqi(aqi) { if (aqi <= 50) return 'Good'; if (aqi <= 100) return 'Moderate'; if (aqi <= 150) return 'Unhealthy for Sensitive Groups'; if (aqi <= 200) return 'Unhealthy'; if (aqi <= 300) return 'Very Unhealthy'; return 'Hazardous'; }
    function getAqiColorClass(aqi) { if (aqi <= 50) return 'aqi-good'; if (aqi <= 100) return 'aqi-moderate'; if (aqi <= 150) return 'aqi-sensitive'; return 'aqi-unhealthy'; }
    function displayAirQualityInfo(data, locationName, position) { infoWindow.setPosition(position); if (data.error || !data.indexes || data.indexes.length === 0) { infoWindow.setContent(`<div class="info-window-content"><strong>${locationName}</strong><br>No air quality data available.</div>`); infoWindow.open(map); return; } const { aqi, dominantPollutant } = data.indexes[0]; const standardCategory = getStandardCategoryFromAqi(aqi); infoWindow.setContent(`<div class="info-window-content"><h3>${locationName}</h3><p><strong>AQI:</strong> ${aqi}</p><p><strong>Category:</strong> ${standardCategory}</p><p><strong>Dominant Pollutant:</strong> ${dominantPollutant}</p></div>`); infoWindow.open(map); }
    function getTimeAgo(date) { const seconds = Math.floor((new Date() - date) / 1000); let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + " years ago"; interval = seconds / 2592000; if (interval > 1) return Math.floor(interval) + " months ago"; interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + " days ago"; interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + " hours ago"; interval = seconds / 60; if (interval > 1) return Math.floor(interval) + " minutes ago"; return Math.floor(seconds) + " seconds ago"; }
    
    document.addEventListener('DOMContentLoaded', () => {
        loadMapScript();
        const toggleButton = document.getElementById('sidebar-toggle-btn');
        const dashboardContainer = document.querySelector('.dashboard-container');
        if (toggleButton && dashboardContainer) {
            toggleButton.addEventListener('click', () => {
                dashboardContainer.classList.toggle('sidebar-collapsed');
                setTimeout(() => { if (map) { google.maps.event.trigger(map, 'resize'); } }, 400);
            });
        }
    });
    </script>
</body>
</html>
