<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Air Quality Monitoring Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body{background-color:#1A1A1A;color:#EAEAEA;font-family:'Inter',sans-serif;margin:0;overflow:hidden}
        .dashboard-header{display:flex;align-items:center;padding:10px 25px;background-color:#F8F9FA;position:relative;border-bottom:1px solid #DEE2E6;height:75px;box-sizing:border-box}
        #header-logo{height:50px;margin-right:20px}
        .header-text{flex-grow:1}
        .header-text h1{font-size:22px;margin-bottom:4px;color:#212529}
        .header-text p{font-size:14px;color:#495057}
        .dashboard-container{display:grid;grid-template-columns:1fr 380px;height:calc(100vh - 75px);padding:15px;gap:15px;transition:grid-template-columns .4s ease-in-out}
        .map-panel,.sidebar{height:100%;position:relative}
        .sidebar{display:flex;flex-direction:column;gap:15px;overflow:hidden}
        .widget{background-color:#2a2a2e;border-radius:8px;padding:15px 20px;display:flex;flex-direction:column}
        .widget-content.scrollable{overflow-y:auto}
        #news-list.widget-content{flex-grow:1}
        .widget-title{margin:0 0 15px;font-weight:500;border-bottom:1px solid #444;padding-bottom:10px}
        .list-item{display:flex;align-items:center;padding:6px 12px;margin:0 -12px;border-radius:4px;cursor:pointer;transition:background-color .2s ease-in-out}
        .list-item:hover{background-color:#3a414a}
        .list-item .city-name{flex-grow:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .list-item .aqi-value{margin-left:15px;flex-shrink:0}
        .aqi-value{font-weight:700}
        .aqi-value.aqi-good{color:#00E400}
        .aqi-value.aqi-moderate{color:#FFFF00}
        .aqi-value.aqi-sensitive{color:#FF7E00}
        .aqi-value.aqi-unhealthy{color:#FF0000}
        #sidebar-toggle-btn{background-color:rgba(76,139,245,.8);color:#fff;border:none;border-radius:5px;padding:8px 12px;font-size:20px;line-height:1;cursor:pointer;transition:background-color .3s;margin-left:20px}
        #sidebar-toggle-btn:hover{background-color:rgba(76,139,245,1)}
        .dashboard-container.sidebar-collapsed{grid-template-columns:1fr 0;gap:0}
        #legend-map{position:absolute;bottom:30px;right:10px;background-color:rgba(30,30,30,.85);backdrop-filter:blur(5px);color:#fff;padding:10px 15px;border-radius:8px;z-index:5;font-size:14px;line-height:1.5;border:1px solid rgba(255,255,255,.1)}
        #legend-map h4{margin:0 0 8px;text-align:center;font-weight:500;border-bottom:1px solid #444;padding-bottom:5px}
        #legend-map div{display:flex;align-items:center;margin-bottom:4px}
        #legend-map div:last-child{margin-bottom:0}
        #legend-map span{width:14px;height:14px;border-radius:50%;margin-right:10px;display:inline-block;border:1px solid #555}
        .error-message{color:#FF7E00}
    </style>
</head>
<body>
    <header class="dashboard-header">
        <img src="Tsinghua_University_logo_and_wordmark_in_Chinese_and_English_characters.svg.png" alt="Tsinghua University Logo" id="header-logo">
        <div class="header-text">
            <h1>Global Air Quality Monitoring Dashboard</h1>
            <p>Group 62 IEDE Research Topic: AI-Driven Environmental Monitoring for a Green Economy</p>
        </div>
        <button id="sidebar-toggle-btn" title="Toggle Sidebar">☰</button>
    </header>
    <div class="dashboard-container">
        <main class="map-panel">
            <div id="map"></div>
            <div id="legend-map">
                <h4>AQI Legend (PM2.5 µg/m³)</h4>
                <div><span style="background-color: #00E400;"></span> 0-12: Good</div>
                <div><span style="background-color: #FFFF00;"></span> 13-35: Moderate</div>
                <div><span style="background-color: #FF7E00;"></span> 36-55: Unhealthy for Sensitive</div>
                <div><span style="background-color: #FF0000;"></span> 55+: Unhealthy</div>
            </div>
        </main>
        <aside class="sidebar">
            <div class="widget">
                <h3 class="widget-title">Top 5 Polluted Stations (PM2.5)</h3>
                <div id="top-stations-list" class="widget-content">
                    <div class="loader">Loading live station data...</div>
                </div>
            </div>
            <div class="widget">
                <h3 class="widget-title">Global PM2.5 Trend (Last 7 Days)</h3>
                <div id="global-trend-chart" class="widget-content">
                    <canvas id="aqiTrendChart"></canvas>
                </div>
            </div>
        </aside>
    </div>

    <script>
    let map, infoWindow, trendChart;
    
    // =================================================================
    // --- API KEYS ---
    // =================================================================
    // Get your free key from https://openaq.org/api
    const openAqApiKey = "9f408ed0e450f2c243ab27af6c475b1b8a4f0b6d776a82b55781cb0ab5190a89"; // <-- PASTE YOUR NEW OpenAQ KEY HERE

    // Get your free key for Google Maps Platform
    const googleMapsApiKey = "AIzaSyB7tXsMopboB-twZRxqkZOGVZau-sqFjTM"; // <-- PASTE YOUR NEW Google Maps KEY HERE
    // =================================================================

    async function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 20, lng: 0 }, zoom: 3, mapTypeId: 'satellite',
            styles: [
                { elementType: 'geometry', stylers: [{ color: '#242f3e' }] }, { elementType: 'labels.text.stroke', stylers: [{ color: '#242f3e' }] }, { elementType: 'labels.text.fill', stylers: [{ color: '#746855' }] }, { featureType: 'administrative.locality', elementType: 'labels.text.fill', stylers: [{ color: '#d59563' }] }, { featureType: 'poi', elementType: 'labels.text.fill', stylers: [{ color: '#d59563' }] }, { featureType: 'poi.park', elementType: 'geometry', stylers: [{ color: '#263c3f' }] }, { featureType: 'poi.park', elementType: 'labels.text.fill', stylers: [{ color: '#6b9a76' }] }, { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#38414e' }] }, { featureType: 'road', elementType: 'geometry.stroke', stylers: [{ color: '#212a37' }] }, { featureType: 'road', elementType: 'labels.text.fill', stylers: [{ color: '#9ca5b3' }] }, { featureType: 'road.highway', elementType: 'geometry', stylers: [{ color: '#746855' }] }, { featureType: 'road.highway', elementType: 'geometry.stroke', stylers: [{ color: '#1f2835' }] }, { featureType: 'road.highway', elementType: 'labels.text.fill', stylers: [{ color: '#f3d19c' }] }, { featureType: 'transit', elementType: 'geometry', stylers: [{ color: '#2f3948' }] }, { featureType: 'transit.station', elementType: 'labels.text.fill', stylers: [{ color: '#d59563' }] }, { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#17263c' }] }, { featureType: 'water', elementType: 'labels.text.fill', stylers: [{ color: '#515c6d' }] }, { featureType: 'water', elementType: 'labels.text.stroke', stylers: [{ color: '#17263c' }] }
            ]
        });
        infoWindow = new google.maps.InfoWindow();

        await initCharts();
        
        const topStationsListContainer = document.getElementById('top-stations-list');
        try {
            const liveTopStations = await fetchOpenAqTopStations();
            if (liveTopStations && liveTopStations.length > 0) {
                populateTopStationsList(liveTopStations);
            } else {
                topStationsListContainer.innerHTML = '<div class="error-message">Could not load station data. Check OpenAQ API Key.</div>';
            }
        } catch (error) {
            topStationsListContainer.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
        }
        document.getElementById('top-stations-list').addEventListener('click', handleStationClick);
    }
    
    async function fetchOpenAqTopStations() {
        const url = 'https://api.openaq.org/v2/latest?limit=100&page=1&offset=0&sort=desc&parameter=pm25&radius=1000&order_by=value';
        const options = { method: 'GET', headers: { accept: 'application/json' } };
        if (openAqApiKey && openAqApiKey !== 'YOUR_OPENAQ_API_KEY') {
            options.headers['X-API-Key'] = openAqApiKey;
        }

        const response = await fetch(url, options);
        if (!response.ok) throw new Error(`OpenAQ Stations API Error: ${response.status}`);
        const data = await response.json();
        
        return data.results.slice(0, 5).map(station => ({
            name: station.location,
            lat: station.coordinates.latitude,
            lng: station.coordinates.longitude,
            value: station.value,
            unit: station.parameter
        }));
    }

    async function fetchOpenAqGlobalTrend() {
        const dateTo = new Date();
        const dateFrom = new Date();
        dateFrom.setDate(dateTo.getDate() - 7);
        const url = `https://api.openaq.org/v2/averages?spatial=global&temporal=day&parameter=pm25&date_from=${dateFrom.toISOString().split('T')[0]}&date_to=${dateTo.toISOString().split('T')[0]}`;
        const options = { method: 'GET', headers: { accept: 'application/json' } };
        if (openAqApiKey && openAqApiKey !== 'YOUR_OPENAQ_API_KEY') {
            options.headers['X-API-Key'] = openAqApiKey;
        }

        const response = await fetch(url, options);
        if (!response.ok) throw new Error(`OpenAQ Trend API Error: ${response.status}`);
        const data = await response.json();
        if (!data.results || data.results.length === 0) return { labels: [], data: [] };
        
        data.results.sort((a, b) => new Date(a.day) - new Date(b.day));
        return {
            labels: data.results.map(r => new Date(r.day).toLocaleDateString(undefined, { weekday: 'short' })),
            data: data.results.map(r => r.average.toFixed(2))
        };
    }

    function populateTopStationsList(stations) {
        const listContainer = document.getElementById('top-stations-list');
        listContainer.innerHTML = ''; 
        stations.forEach((station, index) => {
            const listItem = document.createElement('div');
            listItem.className = 'list-item';
            listItem.setAttribute('data-lat', station.lat);
            listItem.setAttribute('data-lng', station.lng);
            listItem.setAttribute('data-name', station.name);
            listItem.setAttribute('data-value', station.value);
            
            const value = station.value;
            const valueColor = value > 55 ? 'aqi-unhealthy' : (value > 35 ? 'aqi-sensitive' : (value > 12 ? 'aqi-moderate' : 'aqi-good'));

            listItem.innerHTML = `<span class="city-name" title="${station.name}">${index + 1}. ${station.name}</span><span class="aqi-value ${valueColor}">${value}</span>`;
            listContainer.appendChild(listItem);
        });
    }
    
    async function initCharts() {
        const ctx = document.getElementById('aqiTrendChart').getContext('2d');
        const trendData = await fetchOpenAqGlobalTrend();
        const chartLabel = trendData.labels.length > 0 ? 'Global Avg PM2.5' : 'Could not load trend data';
        trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: trendData.labels.length > 0 ? trendData.labels : ['N/A'],
                datasets: [{
                    label: chartLabel, data: trendData.data, borderColor: '#4C8BF5',
                    backgroundColor: 'rgba(76, 139, 245, 0.2)', fill: true, tension: 0.4
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { y: { beginAtZero: false, title: { display: true, text: 'PM2.5 (µg/m³)' } } },
                plugins: { legend: { display: true } }
            }
        });
    }

    function handleStationClick(event) {
        const stationItem = event.target.closest('.list-item');
        if (!stationItem) return;
        const lat = parseFloat(stationItem.dataset.lat);
        const lng = parseFloat(stationItem.dataset.lng);
        const name = stationItem.dataset.name;
        const value = parseFloat(stationItem.dataset.value);
        const location = new google.maps.LatLng(lat, lng);
        map.setCenter(location);
        map.setZoom(11);
        infoWindow.setPosition(location);
        infoWindow.setContent(`<div class="info-window-content"><h3>${name}</h3><p><strong>PM2.5:</strong> ${value} µg/m³</p></div>`);
        infoWindow.open(map);
    }

    function loadMapScript() {
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${googleMapsApiKey}&callback=initMap`;
        script.async = true; script.defer = true;
        script.onerror = () => { document.getElementById('map').innerText = 'Error: Could not load Google Maps...'; };
        document.head.appendChild(script);
    }

    document.addEventListener('DOMContentLoaded', loadMapScript);
    </script>
</body>
</html>
