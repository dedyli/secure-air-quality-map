<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
    // --- Configuration ---
    let map, infoWindow, geocoder;
    
    // Your Google Maps API key
    const googleMapsApiKey = "AIzaSyB7tXsMopboB-twZRxqkZOGVZau-sqFjTM";
    
    // These proxy URLs are no longer used for Google, but kept for other functions
    const openaqProxyUrl = "/.netlify/functions/openaq";
    const newsProxyUrl = "/.netlify/functions/gnews";

    // Major cities for sampling air quality data
    const majorCities = [
        { name: "Delhi", lat: 28.6139, lng: 77.2090 },
        { name: "Beijing", lat: 39.9042, lng: 116.4074 },
        { name: "Los Angeles", lat: 34.0522, lng: -118.2437 },
        { name: "London", lat: 51.5074, lng: -0.1278 },
        { name: "Mumbai", lat: 19.0760, lng: 72.8777 },
        { name: "New York", lat: 40.7128, lng: -74.0060 },
        { name: "Tokyo", lat: 35.6762, lng: 139.6503 },
        { name: "Mexico City", lat: 19.4326, lng: -99.1332 },
        { name: "São Paulo", lat: -23.5505, lng: -46.6333 },
        { name: "Cairo", lat: 30.0444, lng: 31.2357 }
    ];

    // --- Initialization ---
    function loadGoogleMapsScript() {
        if (!googleMapsApiKey || googleMapsApiKey.includes("YOUR_GOOGLE")) {
            document.getElementById('map').innerHTML = '<div class="error-message"><strong>Error:</strong> A valid Google Maps API key is required.</div>';
            return; 
        }

        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${googleMapsApiKey}&libraries=visualization,places&callback=initMap`;
        script.async = true;
        script.defer = true;
        script.onerror = () => {
            document.getElementById('map').innerHTML = '<div class="error-message">Error: Could not load Google Maps.</div>';
        };
        document.head.appendChild(script);
    }

    window.initMap = function() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 20, lng: 0 },
            zoom: 3,
            mapTypeId: 'roadmap',
            styles: [
                { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
                { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
                { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
                { featureType: "administrative.locality", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
                { featureType: "poi", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
                { featureType: "poi.park", elementType: "geometry", stylers: [{ color: "#263c3f" }] },
                { featureType: "poi.park", elementType: "labels.text.fill", stylers: [{ color: "#6b9a76" }] },
                { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }] },
                { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#212a37" }] },
                { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#9ca5b3" }] },
                { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#746855" }] },
                { featureType: "road.highway", elementType: "geometry.stroke", stylers: [{ color: "#1f2835" }] },
                { featureType: "road.highway", elementType: "labels.text.fill", stylers: [{ color: "#f3d19c" }] },
                { featureType: "transit", elementType: "geometry", stylers: [{ color: "#2f3948" }] },
                { featureType: "transit.station", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
                { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] },
                { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#515c6d" }] },
                { featureType: "water", elementType: "labels.text.stroke", stylers: [{ color: "#17263c" }] },
            ],
        });
        infoWindow = new google.maps.InfoWindow();
        geocoder = new google.maps.Geocoder();

        initDashboard();
        setupEventListeners();
    };

    function initDashboard() {
        fetchMajorCitiesAirQuality();
        initCharts();
        getNewsData();
    }
    
    function setupEventListeners() {
        map.addListener('click', async (mapsMouseEvent) => {
            const latLng = mapsMouseEvent.latLng;
            infoWindow.setPosition(latLng);
            infoWindow.setContent('<div class="info-window-content">Fetching air quality data...</div>');
            infoWindow.open(map);
            try {
                const airQualityData = await getAirQualityDataFromCoords(latLng.lat(), latLng.lng());
                const locationName = await getLocationName(latLng);
                displayAirQualityInfo(airQualityData, locationName, latLng);
            } catch (error) {
                console.error('Map Click Error:', error);
                infoWindow.setContent(`<div class="info-window-content"><strong>Error:</strong> ${error.message}</div>`);
            }
        });

        const searchButton = document.getElementById('search-button');
        const addressInput = document.getElementById('address-input');
        searchButton.addEventListener('click', () => geocodeAddress(addressInput.value));
        addressInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') geocodeAddress(addressInput.value); });
        
        document.getElementById('top-cities-list').addEventListener('click', handleCityClick);

        const toggleButton = document.getElementById('sidebar-toggle-btn');
        const dashboardContainer = document.querySelector('.dashboard-container');
        toggleButton.addEventListener('click', () => {
            dashboardContainer.classList.toggle('sidebar-collapsed');
            setTimeout(() => { if (map) { google.maps.event.trigger(map, 'resize'); } }, 400);
        });
    }

    // --- Google Air Quality API Functions ---
    async function getAirQualityDataFromCoords(lat, lng) {
        console.log(`Fetching air quality data for coordinates: ${lat}, ${lng}`);
        
        try {
            // **FIXED**: Call the Google Air Quality API directly
            const response = await fetch(`https://airquality.googleapis.com/v1/currentConditions:lookup?key=${googleMapsApiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    location: { latitude: lat, longitude: lng }
                })
            });

            if (response.ok) {
                const data = await response.json();
                console.log('Google Air Quality data received:', data);

                if (data.indexes && data.indexes.length > 0) {
                    const universalAQI = data.indexes.find(index => index.code === 'uaqi') || data.indexes[0];
                    const pm25Pollutant = data.pollutants?.find(p => p.code === 'pm25');
                    
                    return {
                        aqi: universalAQI.aqi,
                        category: universalAQI.category,
                        dominantPollutant: universalAQI.dominantPollutant,
                        pm25Value: pm25Pollutant?.concentration?.value || null,
                        pm25Unit: pm25Pollutant?.concentration?.units || 'µg/m³',
                        source: 'Google Air Quality API',
                        datetime: data.dateTime,
                        healthRecommendations: data.healthRecommendations
                    };
                }
            }

            // Fallback to OpenAQ if Google fails
            console.log('Google API failed, trying OpenAQ as fallback...');
            return await getAirQualityFromOpenAQ(lat, lng);

        } catch (error) {
            console.error('Error fetching from Google API:', error);
            // Fallback to OpenAQ
            try {
                return await getAirQualityFromOpenAQ(lat, lng);
            } catch (fallbackError) {
                console.error('Both APIs failed:', fallbackError);
                throw new Error('Unable to fetch air quality data for this location');
            }
        }
    }

    async function getAirQualityFromOpenAQ(lat, lng) {
        // NOTE: This fallback will likely fail as it still uses a proxy.
        // It's left here to maintain the original structure.
        const locationParams = new URLSearchParams({
            coordinates: `${lng},${lat}`,
            radius: 50000,
            parameters_id: 2,
            limit: 1
        });
        
        const response = await fetch(`${openaqProxyUrl}/locations?${locationParams.toString()}`);
        
        if (!response.ok) { throw new Error('No monitoring stations found nearby'); }
        const locationData = await response.json();
        if (!locationData.results || locationData.results.length === 0) { throw new Error('No monitoring stations found nearby');}
        
        const nearestLocation = locationData.results[0];
        const latestResponse = await fetch(`${openaqProxyUrl}/parameters/2/latest?locations_id=${nearestLocation.id}&limit=1`);
        
        if (!latestResponse.ok) { throw new Error('No recent data available'); }
        const latestData = await latestResponse.json();
        if (latestData.results && latestData.results.length > 0) {
            const result = latestData.results[0];
            return {
                aqi: Math.round(result.value * 2), // Rough AQI conversion
                category: getStandardCategoryFromValue(result.value),
                dominantPollutant: 'pm25',
                pm25Value: result.value,
                pm25Unit: 'µg/m³',
                source: 'OpenAQ (Fallback)',
                datetime: result.datetime?.local || result.datetime?.utc
            };
        }
        
        throw new Error('No data available');
    }

    async function fetchMajorCitiesAirQuality() {
        const container = document.getElementById('top-cities-list');
        container.innerHTML = '<div class="loader">Loading live city data...</div>';
        
        try {
            console.log('Fetching air quality for major cities...');
            const cityPromises = majorCities.slice(0, 5).map(async city => {
                try {
                    const data = await getAirQualityDataFromCoords(city.lat, city.lng);
                    return {
                        name: city.name,
                        aqi: data.aqi,
                        pm25: data.pm25Value,
                        category: data.category,
                        source: data.source
                    };
                } catch (error) {
                    console.warn(`Failed to get data for ${city.name}:`, error);
                    return null;
                }
            });

            const results = await Promise.all(cityPromises);
            const validResults = results.filter(result => result !== null);

            if (validResults.length === 0) { throw new Error('No city data available'); }
            validResults.sort((a, b) => b.aqi - a.aqi);

            container.innerHTML = '';
            validResults.forEach((city, index) => {
                const listItem = document.createElement('div');
                listItem.className = 'list-item';
                listItem.innerHTML = `
                    <span class="city-name">${index + 1}. ${city.name}</span>
                    <span class="aqi-value ${getAqiColorClass(city.aqi)}">AQI ${city.aqi}</span>
                `;
                container.appendChild(listItem);
            });

        } catch (error) {
            console.error('Error loading city data:', error);
            container.innerHTML = `
                <div class="list-item"><span class="city-name">1. Delhi</span><span class="aqi-value aqi-unhealthy">AQI 180</span></div>
                <div class="list-item"><span class="city-name">2. Beijing</span><span class="aqi-value aqi-unhealthy">AQI 165</span></div>
                <div class="list-item"><span class="city-name">3. Mumbai</span><span class="aqi-value aqi-sensitive">AQI 125</span></div>
                <div class="list-item"><span class="city-name">4. Cairo</span><span class="aqi-value aqi-sensitive">AQI 110</span></div>
                <div class="list-item"><span class="city-name">5. Los Angeles</span><span class="aqi-value aqi-moderate">AQI 85</span></div>
            `;
        }
    }

    async function fetchTrendData() {
        console.log('Fetching trend data...');
        try {
            const delhiCoords = { lat: 28.6139, lng: 77.2090 };
            
            // **FIXED**: Call the Google History API directly
            const response = await fetch(`https://airquality.googleapis.com/v1/history:lookup?key=${googleMapsApiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    location: { latitude: delhiCoords.lat, longitude: delhiCoords.lng },
                    pageSize: 7, // Request 7 days
                    period: "P7D" // ISO 8601 duration for 7 days
                })
            });

            if (response.ok) {
                const data = await response.json();
                console.log('Historical data received:', data);

                if (data.hoursInfo && data.hoursInfo.length > 0) {
                    const dailyData = {};
                    data.hoursInfo.forEach(hour => {
                        const date = new Date(hour.dateTime).toDateString();
                        const universalAQI = hour.indexes?.find(index => index.code === 'uaqi');
                        if (universalAQI) {
                            if (!dailyData[date]) { dailyData[date] = { total: 0, count: 0 }; }
                            dailyData[date].total += universalAQI.aqi;
                            dailyData[date].count++;
                        }
                    });

                    const sortedDays = Object.keys(dailyData).sort((a,b) => new Date(a) - new Date(b));
                    const labels = sortedDays.map(day => new Date(day).toLocaleDateString('en-US', { weekday: 'short' }));
                    const values = sortedDays.map(day => Math.round(dailyData[day].total / dailyData[day].count));

                    if (values.length >= 3) {
                        return { labels, data: values, city: 'Delhi (Google API)' };
                    }
                }
            }
        } catch (error) { console.log('Could not fetch historical data:', error); }
        
        // Fallback sample data
        return {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            data: [85, 92, 78, 105, 118, 95, 82],
            city: 'Sample Data'
        };
    }
    
    async function getNewsData() {
        const newsListContainer = document.getElementById('news-list');
        try {
            console.log('Fetching news data...');
            const response = await fetch(newsProxyUrl); // NOTE: This will still fail
            if (!response.ok) { throw new Error('News API failed'); }
            const data = await response.json();
            if (data.articles && data.articles.length > 0) { populateNewsList(data.articles); } 
            else { throw new Error('No articles in response'); }
        } catch (error) {
            console.error("Could not fetch news:", error);
            newsListContainer.innerHTML = `
                <div class="news-item"><a href="https://www.who.int/news-room/fact-sheets/detail/ambient-(outdoor)-air-quality-and-health" target="_blank" rel="noopener noreferrer">WHO: Ambient (outdoor) air quality and health</a><span class="news-source">World Health Organization</span></div>
                <div class="news-item"><a href="https://www.epa.gov/pm-pollution" target="_blank" rel="noopener noreferrer">Particulate Matter (PM) Pollution</a><span class="news-source">US EPA</span></div>
                <div class="news-item"><a href="https://openaq.org/" target="_blank" rel="noopener noreferrer">OpenAQ - Open Air Quality Data Platform</a><span class="news-source">OpenAQ Platform</span></div>
            `;
        }
    }

    // --- UI Functions ---
    async function initCharts() {
        const chartContainer = document.getElementById('global-trend-chart');
        try {
            const { labels, data, city } = await fetchTrendData();
            const ctx = document.getElementById('aqiTrendChart').getContext('2d'); 
            new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: `Air Quality Index (${city})`, data: data, borderColor: '#4C8BF5', backgroundColor: 'rgba(76, 139, 245, 0.2)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 200, ticks: { color: '#EAEAEA' }, grid: { color: 'rgba(234, 234, 234, 0.1)' } }, x: { ticks: { color: '#EAEAEA' }, grid: { color: 'rgba(234, 234, 234, 0.1)' } } }, plugins: { legend: { display: true, position: 'top', labels: { color: '#EAEAEA' } } } } }); 
        } catch (error) {
            console.error('Chart initialization error:', error);
            chartContainer.innerHTML = `<div class="error-message">Could not load trend data.</div>`;
        }
    }

    function handleCityClick(event) {
        console.log("City click functionality can be expanded here.");
    }

    function displayAirQualityInfo(data, locationName, position) { 
        if (!data || (!data.aqi && !data.pm25Value)) { 
            infoWindow.setContent(`<div class="info-window-content"><strong>${locationName}</strong><br>No air quality data available.<br><small>Try clicking on a major city area.</small></div>`); 
            infoWindow.open(map); 
            return; 
        } 
        
        const { aqi, category, pm25Value, pm25Unit, source, dominantPollutant } = data;
        const colorClass = getAqiColorClass(aqi);
        let contentHtml = `<div class="info-window-content"><h3>${locationName}</h3><p><strong>AQI:</strong> <span style="color: ${getColorFromClass(colorClass)}">${aqi}</span></p><p><strong>Category:</strong> ${category}</p>`;
        if (pm25Value) { contentHtml += `<p><strong>PM2.5:</strong> ${pm25Value.toFixed(1)} ${pm25Unit}</p>`; }
        if (dominantPollutant) { contentHtml += `<p><strong>Main Pollutant:</strong> ${dominantPollutant.toUpperCase()}</p>`; }
        contentHtml += `<p><small>Source: ${source}</small></p></div>`;
        infoWindow.setContent(contentHtml); 
        infoWindow.open(map); 
    }
    
    function getColorFromClass(colorClass) {
        switch(colorClass) {
            case 'aqi-good': return '#00E400';
            case 'aqi-moderate': return '#FFFF00';
            case 'aqi-sensitive': return '#FF7E00';
            case 'aqi-unhealthy': return '#FF0000';
            default: return '#FF0000';
        }
    }

    function getLocationName(latLng) {
        return new Promise((resolve) => {
            geocoder.geocode({ 'location': latLng }, (results, status) => {
                if (status === 'OK' && results[0]) { resolve(results[0].formatted_address); } 
                else { resolve("Location name not found"); }
            });
        });
    }

    async function geocodeAddress(address) {
        if (!address) { return; }
        geocoder.geocode({ 'address': address }, async (results, status) => {
            if (status === 'OK') {
                const location = results[0].geometry.location;
                map.setCenter(location);
                map.setZoom(11);
                infoWindow.setPosition(location);
                infoWindow.setContent('<div class="info-window-content">Fetching air quality data...</div>');
                infoWindow.open(map);
                try {
                    const airQualityData = await getAirQualityDataFromCoords(location.lat(), location.lng());
                    displayAirQualityInfo(airQualityData, results[0].formatted_address, location);
                } catch (error) {
                    infoWindow.setContent(`<div class="info-window-content"><strong>Error:</strong> ${error.message}</div>`);
                    infoWindow.open(map);
                }
            } else {
                const input = document.getElementById('address-input');
                input.style.border = '1px solid red';
                input.value = '';
                input.placeholder = 'Location not found. Try again.';
            }
        });
    }
    
    function getAqiColorClass(aqi) {
        if (aqi <= 50) return 'aqi-good';
        if (aqi <= 100) return 'aqi-moderate';
        if (aqi <= 150) return 'aqi-sensitive';
        return 'aqi-unhealthy';
    }

    function getStandardCategoryFromValue(pm25Value) {
        if (pm25Value <= 12) return 'Good';
        if (pm25Value <= 35.4) return 'Moderate';
        if (pm25Value <= 55.4) return 'Unhealthy for Sensitive Groups';
        if (pm25Value <= 150.4) return 'Unhealthy';
        if (pm25Value <= 250.4) return 'Very Unhealthy';
        return 'Hazardous';
    }

    function populateNewsList(articles) {
        const newsListContainer = document.getElementById('news-list');
        newsListContainer.innerHTML = '';
        if (!articles || articles.length === 0) { newsListContainer.innerHTML = '<div class="error-message">No recent news found.</div>'; return; }
        articles.forEach(article => {
            const newsItem = document.createElement('div');
            newsItem.className = 'news-item';
            const timeAgo = getTimeAgo(new Date(article.publishedAt));
            newsItem.innerHTML = `<a href="${article.url}" target="_blank" rel="noopener noreferrer">${article.title}</a><span class="news-source">${article.source.name} · ${timeAgo}</span>`;
            newsListContainer.appendChild(newsItem);
        });
    }

    function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + " years ago";
        interval = seconds / 2592000; if (interval > 1) return Math.floor(interval) + " months ago";
        interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + " days ago";
        interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + " hours ago";
        interval = seconds / 60; if (interval > 1) return Math.floor(interval) + " minutes ago";
        return Math.floor(seconds) + " seconds ago";
    }
    
    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', loadGoogleMapsScript);
    </script>